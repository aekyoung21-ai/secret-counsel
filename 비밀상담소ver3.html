<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³ ë ¤ ê³ ë“±í•™êµ 2-1ë°˜ì˜ ë¹„ë°€ìƒë‹´ì†Œ (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // --- Supabase í´ë¼ì´ì–¸íŠ¸ ì„í¬íŠ¸ ---
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // ==========================================================
        // âœ… Supabase ì¸ì¦ ì •ë³´ (ì‚¬ìš©ìë‹˜ì˜ í‚¤ë¡œ ì—…ë°ì´íŠ¸ë¨)
        // ==========================================================
        const SUPABASE_URL = 'https://gbkrllkcukjpywhidblj.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdia3JsbGtjdWtqcHl3aGlkYmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MjQ4MjgsImV4cCI6MjA3ODQwMDgyOH0.Z9jhCZ30Vb-rTX_hUL0eiI7qcb2mee3h5qmlfHtSyKw';
        
        const TABLE_NAME = 'counseling_messages';
        const TEACHER_PASSWORD = "21class"; 
        // ==========================================================
        
        // LocalStorage fallback key
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // âœ… í•™ìƒ ìµëª… IDë¥¼ ì €ì¥í•  LocalStorage í‚¤
        const STUDENT_ID_KEY = `student_anonymous_id_${appId}`;

        let supabase = null;
        let userId; 
        let isSupabaseActive = false;
        
        // --- LocalStorage Mock Database (ì˜¤í”„ë¼ì¸ ëª¨ë“œ ì§€ì›) ---
        function createLocalStorageMock() {
            const STORAGE_KEY = `counseling_data_${appId}`;

            function getLocalData() {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            }

            function setLocalData(data) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            }
            
            async function mockInsert(data) {
                const docId = crypto.randomUUID();
                const now = new Date();
                const newData = {
                    ...data,
                    id: docId,
                    created_at: now.toISOString(), 
                };
                const allData = getLocalData();
                allData.push(newData);
                setLocalData(allData);
                if (typeof renderApp === 'function') renderApp();
                return { data: [newData] };
            }
            
            async function mockUpdate(docId, updates) {
                const allData = getLocalData();
                const index = allData.findIndex(d => d.id === docId);
                if (index > -1) {
                    allData[index] = { ...allData[index], ...updates };
                    setLocalData(allData);
                    if (typeof renderApp === 'function') renderApp();
                }
                return { error: null };
            }
            
            async function mockSelect(filterFn = null) {
                 let data = getLocalData();
                 if (filterFn) {
                    data = data.filter(filterFn);
                 }
                 data.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
                 return { data: data };
            }

            return {
                from: () => ({
                    insert: (data) => mockInsert(data),
                    update: (updates) => ({ 
                        eq: (field, value) => ({ execute: () => mockUpdate(value, updates) })
                    }),
                    select: (query = '*') => ({
                        eq: (field, value) => ({ execute: () => mockSelect(d => d[field] === value) }),
                        order: () => ({ execute: () => mockSelect() }), 
                        execute: () => mockSelect() 
                    }),
                }),
                channel: (channelName) => ({
                    on: (event, filter, callback) => ({
                        subscribe: () => {
                            return { unsubscribe: () => {} };
                        }
                    })
                })
            };
        }

        // --- CSV Export Function ---
        function exportToCsv(filename, messages) {
            const header = ["ì‹œê°„", "í•™ìƒ ID (ì• 8ìë¦¬)", "ê³ ë¯¼ ë‚´ìš©", "ì„ ìƒë‹˜ ë‹µë³€", "í™•ì¸ ì—¬ë¶€"];
            
            const rows = messages.map(msg => [
                formatTimestamp(msg.created_at, true), 
                // âœ… studentIDë¡œ ìˆ˜ì •
                msg.studentID.substring(0, 8), 
                `"${msg.message.replace(/"/g, '""').replace(/\n/g, ' ')}"`, 
                `"${msg.reply.replace(/"/g, '""').replace(/\n/g, ' ')}"`,
                msg.viewed ? "O" : "X"
            ]);

            const csvContent = [
                header.join(","),
                ...rows.map(e => e.join(","))
            ].join("\n");

            const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }


        // --- Tailwind CSS ì‚¬ìš©ì ì •ì˜ ì„¤ì • (ë² ì´ì§€ í…Œë§ˆ) ---
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'beige-warm': '#FAF8F0', 
                        'beige-light': '#F5F5DC', 
                        'brown-dark': '#4A3728', 
                        'brown-medium': '#79665A', 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        }

        // --- ë°ì´í„° ë° ë©”ì‹œì§€ ---
        const encouragingMessages = [
            "ì˜¤ëŠ˜ë„ í˜ì°¨ê²Œ ì‹œì‘! ë„ˆì˜ í•˜ë£¨ë¥¼ ì‘ì›í•´.",
            "ì˜í•˜ê³  ìˆì–´, ì¶©ë¶„íˆ ë©‹ì§„ í•˜ë£¨ë¥¼ ë³´ë‚´ê³  ìˆë‹¤ëŠ” ê±¸ ìŠì§€ ë§ˆ.",
            "ê±±ì •í•˜ì§€ ë§ˆ. ëª¨ë“  ê³ ë¯¼ì€ ì„±ì¥ìœ¼ë¡œ ê°€ëŠ” ê¸¸ëª©ì´ì•¼.",
            "ìˆ¨ê²¨ì§„ ë„ˆì˜ ì ì¬ë ¥ì„ ë¯¿ì–´. íŒŒì´íŒ…!",
            "ì ì‹œ ì‰¬ì–´ê°€ë„ ê´œì°®ì•„. ë„ˆì˜ ì†ë„ì— ë§ì¶° ê±¸ì–´ê°€ë ´.",
            "2í•™ë…„ 1ë°˜, ëª¨ë‘ì—ê²Œ ì¢‹ì€ ì¼ì´ ê°€ë“í•˜ê¸¸ ë°”ë¼!",
            "ì„ ìƒë‹˜ì€ í•­ìƒ ë„ˆí¬ë¥¼ ì§€ì¼œë³´ê³  ìˆë‹¨ë‹¤. í˜ë‚´ë ´.",
        ];

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function getDailyMessage() {
            const today = new Date().toDateString();
            let seed = 0;
            for(let i = 0; i < today.length; i++) {
                seed += today.charCodeAt(i);
            }
            const index = seed % encouragingMessages.length;
            return encouragingMessages[index];
        }

        function formatTimestamp(timestampString) {
            if (!timestampString) return 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
            try {
                const date = new Date(timestampString);
                return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                console.error("Timestamp format error:", e);
                return 'ì‹œê°„ ì •ë³´ ì˜¤ë¥˜';
            }
        }

        // --- Supabase/DB ì´ˆê¸°í™” ---

        async function initDB() {
            try {
                // âœ… LocalStorageì—ì„œ ê¸°ì¡´ userId ë¡œë“œ ë˜ëŠ” ìƒˆë¡œ ìƒì„±
                let storedUserId = localStorage.getItem(STUDENT_ID_KEY);
                if (!storedUserId) {
                    storedUserId = crypto.randomUUID();
                    localStorage.setItem(STUDENT_ID_KEY, storedUserId);
                }
                userId = storedUserId;
                
                // Supabase ì—°ê²° ì‹œë„
                if (SUPABASE_URL && SUPABASE_ANON_KEY) {
                    supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                        auth: { persistSession: false }, 
                    });
                    isSupabaseActive = true; 
                    
                    document.getElementById('user-id-display').textContent = `ì‚¬ìš©ì ID: ${userId.substring(0, 8)}... (Supabase ì—°ê²°ë¨)`;
                }
                
                initApp();

            } catch (error) {
                console.error("DB ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ LocalStorage Mockìœ¼ë¡œ ëŒ€ì²´
                supabase = createLocalStorageMock(); 
                isSupabaseActive = false;
                document.getElementById('user-id-display').textContent = `ì‚¬ìš©ì ID: ${userId.substring(0, 8)}... (DB ì—°ê²° ì˜¤ë¥˜, ì˜¤í”„ë¼ì¸ ëª¨ë“œ í™œì„±í™”)`;
                initApp();
            }
        }

        // --- í•™ìƒ/êµì‚¬ ëª¨ë“œ ì „í™˜ ---
        let currentView = 'student'; 
        let teacherSubscription = null;
        let studentSubscription = null;

        function toggleView() {
            const toggleButton = document.getElementById('view-toggle-button');
            if (currentView === 'student') {
                showPasswordModal();
            } else {
                currentView = 'student';
                renderApp();
                toggleButton.textContent = "êµì‚¬ìš© í˜ì´ì§€ë¡œ ì „í™˜";
                toggleButton.classList.remove('bg-red-500');
                toggleButton.classList.add('bg-brown-medium');
                // êµì‚¬ ëª¨ë“œì—ì„œ í•™ìƒ ëª¨ë“œë¡œ ëŒì•„ê°ˆ ë•Œ êµ¬ë… í•´ì œ
                if (teacherSubscription) supabase.removeChannel(teacherSubscription);
                teacherSubscription = null;
            }
        }
        
        function showPasswordModal() {
            const modal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('password-input');
            passwordInput.value = ''; 
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                passwordInput.focus();
            }, 10);
        }

        function handlePasswordCheck() {
            const passwordInput = document.getElementById('password-input');
            const password = passwordInput.value;
            const modal = document.getElementById('password-modal');

            if (password === TEACHER_PASSWORD) {
                currentView = 'teacher';
                renderApp();
                const toggleButton = document.getElementById('view-toggle-button');
                toggleButton.textContent = "í•™ìƒ ëª¨ë“œë¡œ ëŒì•„ê°€ê¸°";
                toggleButton.classList.remove('bg-brown-medium');
                toggleButton.classList.add('bg-red-500');
                
                modal.classList.remove('opacity-100');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);

            } else {
                modal.classList.remove('opacity-100');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    showModal('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }, 300);
            }
        }

        // --- í•™ìƒ í˜ì´ì§€ ê¸°ëŠ¥ ---

        async function handleStudentSubmit(event) {
            event.preventDefault();
            const messageInput = document.getElementById('student-message-input');
            const message = messageInput.value.trim();

            if (!message) {
                showModal("ê³ ë¯¼ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            if (!supabase) {
                showModal("ë°ì´í„°ë² ì´ìŠ¤ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ê³ ë¯¼ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            try {
                // Supabase insert (ì˜¤í”„ë¼ì¸/Mock ëª¨ë“œë„ ì´ ê²½ë¡œë¥¼ ì‚¬ìš©)
                const { error } = await supabase
                    .from(TABLE_NAME)
                    .insert([
                        { 
                            // âœ… studentIDë¡œ ìˆ˜ì •
                            studentID: userId,
                            message: message,
                            reply: '', 
                            viewed: false 
                        }
                    ]);
                    
                if (error) throw error;

                messageInput.value = '';
                showModal("ê³ ë¯¼ì´ ì„ ìƒë‹˜ì—ê²Œ ë¬´ì‚¬íˆ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤! ê°ì‚¬í•©ë‹ˆë‹¤.");
            } catch (e) {
                console.error("ê³ ë¯¼ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ", e);
                showModal("ê³ ë¯¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
            }
        }

        // --- êµì‚¬ í˜ì´ì§€ ê¸°ëŠ¥ ---

        // âœ… ë·°(viewed) ìƒíƒœ í† ê¸€ í•¸ë“¤ëŸ¬ ì¶”ê°€
        async function handleViewedToggle(docId, isChecked) {
            if (!supabase) {
                showModal("ë°ì´í„°ë² ì´ìŠ¤ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            try {
                const { error } = await supabase
                    .from(TABLE_NAME)
                    .update({
                        viewed: isChecked
                    })
                    .eq('id', docId);

                if (error) throw error;
                // ë©”ì‹œì§€ í† ê¸€ ì„±ê³µ ì‹œ ì•Œë¦¼ì€ ìƒëµí•˜ê³  ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ì— ë§¡ê¹ë‹ˆë‹¤.

            } catch (e) {
                console.error("í™•ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ", e);
                showModal("í™•ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
            }
        }

        // CSV ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
        async function handleExportToCsv() {
            if (!supabase || !isSupabaseActive) {
                showModal("ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°ë˜ì§€ ì•Šì•„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            
            try {
                // Supabaseì—ì„œ ëª¨ë“  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. created_at ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                const { data, error } = await supabase
                    .from(TABLE_NAME)
                    .select('*')
                    .order('created_at', { ascending: false }); 

                if (error) throw error;
                
                const filename = `ê³ ë ¤ê³ _2-1ë°˜_ë¹„ë°€ìƒë‹´ì†Œ_ë°ì´í„°_${new Date().toISOString().slice(0, 10)}.csv`;
                exportToCsv(filename, data || []);
                
                showModal("CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.");

            } catch (e) {
                console.error("CSV ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
                showModal("ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
            }
        }
        
        function renderTeacherView() {
            const appContainer = document.getElementById('app-content');
            
            // ê¸°ì¡´ êµ¬ë… í•´ì œ ë° ì±„ë„ ì œê±°
            if (teacherSubscription) supabase.removeChannel(teacherSubscription);

            if (!supabase || !isSupabaseActive) {
                 appContainer.innerHTML = `
                    <p class="text-red-600 p-8 text-center bg-white rounded-xl shadow-xl">
                        ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°ë˜ì§€ ì•Šì•„ í•™ìƒë“¤ì˜ ê³ ë¯¼ì„ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì˜¤í”„ë¼ì¸ ëª¨ë“œ)
                    </p>
                 `;
                 return;
            }

            appContainer.innerHTML = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center border-b pb-2">
                        <h2 class="text-2xl font-bold text-brown-dark">í•™ìƒë“¤ì˜ ê³ ë¯¼ í™•ì¸ ë° ë‹µë³€</h2>
                        <button id="export-csv-button" class="bg-green-600 text-white py-2 px-4 rounded-lg text-sm hover:bg-green-700 transition duration-200 shadow-md">
                            ëª¨ë“  ê³ ë¯¼ CSVë¡œ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                    <div id="messages-list" class="space-y-4">
                        <p class="text-brown-medium">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            `;
            
            document.getElementById('export-csv-button').addEventListener('click', handleExportToCsv);
            const messagesList = document.getElementById('messages-list');
            
            // ë°ì´í„° ë Œë”ë§ í•¨ìˆ˜
            const renderTeacherMessages = async () => {
                 const { data: allMessages, error } = await supabase
                    .from(TABLE_NAME)
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error("Supabase data fetch error:", error);
                    messagesList.innerHTML = `<p class="text-red-600">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`;
                    return;
                }

                messagesList.innerHTML = '';
                
                if (!allMessages || allMessages.length === 0) {
                    messagesList.innerHTML = `<p class="text-brown-medium p-4 bg-beige-light rounded-lg shadow-inner">ì•„ì§ ì ‘ìˆ˜ëœ ê³ ë¯¼ì´ ì—†ìŠµë‹ˆë‹¤. í‰í™”ë¡œìš´ 2-1ë°˜ì´ë„¤ìš”!</p>`;
                    return;
                }
                
                allMessages.forEach((data) => {
                    const docId = data.id;
                    const timeString = formatTimestamp(data.created_at);
                    const isReplied = !!data.reply;
                    const isViewed = data.viewed;

                    const messageElement = document.createElement('div');
                    messageElement.className = 'bg-white p-4 rounded-xl shadow-lg border border-beige-light';
                    messageElement.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-xs text-gray-500">
                                <span class="font-bold text-brown-dark">${data.studentID.substring(0, 8)}...</span> í•™ìƒ | 
                                ${timeString}
                            </p>
                            <!-- âœ… í™•ì¸ ìƒíƒœ í† ê¸€ ë²„íŠ¼ ì¶”ê°€ -->
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" data-doc-id="${docId}" ${isViewed ? 'checked' : ''} class="viewed-toggle form-checkbox h-4 w-4 ${isViewed ? 'text-green-600' : 'text-gray-400'} rounded border-gray-300 transition duration-150">
                                <span class="text-xs ${isViewed ? 'text-green-600 font-semibold' : 'text-gray-600'}">${isViewed ? 'í™•ì¸ë¨' : 'ë¯¸í™•ì¸'}</span>
                            </label>
                            <!-- ---------------------------- -->
                        </div>

                        <div class="bg-beige-warm p-3 rounded-lg mb-3">
                            <p class="text-brown-dark font-medium whitespace-pre-wrap">
                                Q: ${data.message}
                            </p>
                        </div>

                        ${isReplied ? `
                            <div class="border-t pt-3 mt-3">
                                <p class="text-sm font-bold text-green-600 mb-1">ì„ ìƒë‹˜ ë‹µë³€:</p>
                                <p class="text-brown-medium whitespace-pre-wrap">${data.reply}</p>
                            </div>
                        ` : `
                            <div class="border-t pt-3 mt-3">
                                <textarea id="reply-input-${docId}" rows="3" class="w-full p-2 border rounded-lg focus:ring-brown-medium focus:border-brown-medium resize-none" placeholder="ì—¬ê¸°ì— ë‹µë³€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
                                <button data-doc-id="${docId}" class="reply-button mt-2 w-full bg-brown-medium text-white py-2 rounded-lg hover:bg-brown-dark transition duration-200 shadow-md">
                                    ë‹µë³€ ì™„ë£Œ
                                </button>
                            </div>
                        `}
                    `;
                    messagesList.appendChild(messageElement);
                });

                // ë‹µë³€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                messagesList.querySelectorAll('.reply-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const docId = e.target.dataset.docId;
                        const replyInput = document.getElementById(`reply-input-${docId}`);
                        handleTeacherReply(docId, replyInput.value);
                    });
                });

                // âœ… í™•ì¸ ìƒíƒœ í† ê¸€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                messagesList.querySelectorAll('.viewed-toggle').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const docId = e.target.dataset.docId;
                        handleViewedToggle(docId, e.target.checked);
                    });
                });
            };
            
            // ìµœì´ˆ ë°ì´í„° ë¡œë“œ
            renderTeacherMessages();
            
            // Supabase Realtime Subscription ì„¤ì • (Channel ì‚¬ìš©)
            const teacherChannel = supabase.channel('teacher_all_messages_channel');

            teacherSubscription = teacherChannel
                .on(
                    'postgres_changes', 
                    { event: '*', schema: 'public', table: TABLE_NAME },
                    (payload) => {
                        console.log('Realtime change for teacher:', payload);
                        renderTeacherMessages();
                    }
                )
                .subscribe(); // êµ¬ë… ì‹œì‘
        }

        async function handleTeacherReply(docId, replyText) {
            const reply = replyText.trim();
            if (!reply) {
                showModal("ë‹µë³€ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            if (!supabase) {
                showModal("ë°ì´í„°ë² ì´ìŠ¤ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ë‹µë³€ì„ ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            try {
                // Supabase update by ID (primary key)
                const { error } = await supabase
                    .from(TABLE_NAME)
                    .update({
                        reply: reply,
                        viewed: true // ë‹µë³€í•˜ë©´ ë¬´ì¡°ê±´ í™•ì¸ë¨ìœ¼ë¡œ ì²˜ë¦¬
                    })
                    .eq('id', docId); 

                if (error) throw error;

                showModal("ë‹µë³€ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            } catch (e) {
                console.error("ë‹µë³€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ", e);
                showModal("ë‹µë³€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
            }
        }

        // --- ë©”ì¸ ë Œë”ë§ í•¨ìˆ˜ ---
        function renderApp() {
            const appContent = document.getElementById('app-content');
            if (!appContent) return;
            
            // í•™ìƒ ëª¨ë“œë¡œ ì „í™˜ ì‹œ êµì‚¬ êµ¬ë… í•´ì œ
            if (currentView === 'student' && teacherSubscription) {
                supabase.removeChannel(teacherSubscription);
                teacherSubscription = null;
            }
            
            if (currentView === 'student') {
                const dailyMessage = getDailyMessage();
                appContent.innerHTML = `
                    <div class="space-y-8">
                        <!-- ì˜¤ëŠ˜ì˜ ì‘ì› ë©”ì‹œì§€ -->
                        <div class="bg-beige-light p-6 rounded-xl shadow-inner border-2 border-beige-warm">
                            <p class="text-sm font-bold text-brown-dark mb-2">ğŸ’Œ ì˜¤ëŠ˜ì˜ ì„ ìƒë‹˜ ë©”ì‹œì§€:</p>
                            <p class="text-lg text-brown-medium font-semibold">${dailyMessage}</p>
                        </div>
                        
                        <!-- ê³ ë¯¼ ì‘ì„± í¼ -->
                        <div class="bg-white p-6 rounded-xl shadow-2xl">
                            <h2 class="text-xl font-bold text-brown-dark mb-4 border-b pb-2">ë‚˜ë§Œì˜ ë¹„ë°€ ê³ ë¯¼ ì‘ì„±í•˜ê¸°</h2>
                            <form id="student-submit-form">
                                <textarea id="student-message-input" rows="8" class="w-full p-4 border border-beige-medium rounded-lg focus:ring-brown-medium focus:border-brown-medium transition duration-200 resize-none" placeholder="ì„ ìƒë‹˜ê»˜ í„¸ì–´ë†“ê³  ì‹¶ì€ ê³ ë¯¼ì„ ìµëª…ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. (ì–¸ì œë“ ì§€ ê´œì°®ìŠµë‹ˆë‹¤!)"></textarea>
                                <button type="submit" class="mt-4 w-full bg-brown-medium text-white font-bold py-3 rounded-xl hover:bg-brown-dark transition duration-300 shadow-lg">
                                    ì„ ìƒë‹˜ê»˜ ìµëª…ìœ¼ë¡œ ì „ì†¡í•˜ê¸°
                                </button>
                            </form>
                            <p class="text-xs text-gray-400 mt-3 text-center">
                                * ì‘ì„±ëœ ë‚´ìš©ì€ 2-1ë°˜ ì„ ìƒë‹˜ë§Œ í™•ì¸í•˜ê³  ë‹µì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>

                        <!-- ë‚´ ê³ ë¯¼ í™•ì¸í•˜ê¸° (ì„ íƒ ì‚¬í•­) -->
                        <div class="bg-white p-6 rounded-xl shadow-xl">
                            <h3 class="text-xl font-bold text-brown-dark mb-4 border-b pb-2">ë‚´ê°€ ë³´ë‚¸ ê³ ë¯¼ê³¼ ë‹µë³€ í™•ì¸</h3>
                            <div id="my-messages-list" class="space-y-3">
                                <p class="text-brown-medium">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('student-submit-form').addEventListener('submit', handleStudentSubmit);
                loadMyMessages();

            } else {
                renderTeacherView();
            }
        }
        
        function loadMyMessages() {
            const myMessagesList = document.getElementById('my-messages-list');
            
            // ê¸°ì¡´ êµ¬ë… í•´ì œ ë° ì±„ë„ ì œê±°
            if (studentSubscription) supabase.removeChannel(studentSubscription);

            if (!supabase || !isSupabaseActive) {
                myMessagesList.innerHTML = `<p class="text-red-600 text-center p-2">ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°ë˜ì§€ ì•Šì•„ ë‚˜ì˜ ê³ ë¯¼ì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì˜¤í”„ë¼ì¸ ëª¨ë“œ)</p>`;
                return;
            }
            
            // ë°ì´í„° ë Œë”ë§ í•¨ìˆ˜
            const renderStudentMessages = async () => {
                const { data: myMessages, error } = await supabase
                    .from(TABLE_NAME)
                    .select('*')
                    // âœ… studentIDë¡œ ìˆ˜ì •
                    .eq('studentID', userId) 
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error("Supabase student data fetch error:", error);
                    myMessagesList.innerHTML = `<p class="text-red-600 text-center p-2 font-bold">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`;
                    return;
                }
                
                myMessagesList.innerHTML = '';
                
                if (!myMessages || myMessages.length === 0) {
                    myMessagesList.innerHTML = `<p class="text-brown-medium text-center p-2">ì•„ì§ ë³´ë‚¸ ê³ ë¯¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    return;
                }

                myMessages.forEach((data) => {
                    const timeString = formatTimestamp(data.created_at);

                    const messageElement = document.createElement('div');
                    messageElement.innerHTML = `
                        <details class="border border-beige-light p-3 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition duration-200">
                            <summary class="list-none flex justify-between items-center text-brown-dark font-medium p-1 -m-1">
                                <span class="${data.reply ? 'text-green-600' : 'text-yellow-600'} flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="${data.reply ? 'M22 11.08V12a10 10 0 1 1-5.93-9.14' : 'M12 2v10'}"/>
                                        <path d="${data.reply ? 'M22 4L12 14l-3-3' : 'M12 22v-4'}"/>
                                    </svg>
                                    ${data.reply ? 'ë‹µë³€ ì™„ë£Œ' : 'ë‹µë³€ ëŒ€ê¸° ì¤‘'}
                                </span>
                                <span class="text-xs text-gray-500">${timeString}</span>
                            </summary>
                            
                            <!-- Detail Content -->
                            <div class="mt-3 pt-3 border-t border-beige-light space-y-3">
                                <p class="text-sm font-bold text-brown-dark">ë‚˜ì˜ ê³ ë¯¼:</p>
                                <div class="bg-beige-warm p-3 rounded-lg whitespace-pre-wrap text-brown-medium border border-gray-200">
                                    ${data.message}
                                </div>
                                
                                ${data.reply ? `
                                    <p class="text-sm font-bold text-green-700">ì„ ìƒë‹˜ ë‹µë³€:</p>
                                    <div class="p-3 bg-green-50 rounded-md border border-green-200 whitespace-pre-wrap text-brown-medium">
                                        ${data.reply}
                                    </div>
                                ` : `
                                    <p class="text-sm text-yellow-600 font-semibold mt-2 p-2 bg-yellow-50 rounded-md border border-yellow-200">
                                        ì„ ìƒë‹˜ì˜ ë”°ëœ»í•œ ë‹µë³€ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
                                    </p>
                                `}
                            </div>
                        </details>
                    `;
                    myMessagesList.appendChild(messageElement);
                });
            };

            // ìµœì´ˆ ë°ì´í„° ë¡œë“œ
            renderStudentMessages();

            // Supabase Realtime Subscription ì„¤ì • (Channel ì‚¬ìš©)
            const studentChannel = supabase.channel(`student_message_${userId}`); 

            studentSubscription = studentChannel
                .on(
                    'postgres_changes', 
                    { event: '*', schema: 'public', table: TABLE_NAME },
                    (payload) => {
                        console.log('Realtime change for student:', payload);
                        renderStudentMessages();
                    }
                )
                .subscribe(); // êµ¬ë… ì‹œì‘
        }


        // --- ì»¤ìŠ¤í…€ ëª¨ë‹¬ (Alert ëŒ€ì²´) ---
        function showModal(message) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-message').textContent = message;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('custom-modal');
            modal.classList.remove('opacity-100');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        
        // --- ì•± ì‹œì‘ ---
        function initApp() {
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            document.getElementById('view-toggle-button').addEventListener('click', toggleView);
            document.getElementById('close-modal-button').addEventListener('click', closeModal);
            document.getElementById('password-check-button').addEventListener('click', handlePasswordCheck);
            
            // Enter í‚¤ ì…ë ¥ ì‹œ ë¹„ë°€ë²ˆí˜¸ ì²´í¬
            document.getElementById('password-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handlePasswordCheck();
                }
            });
            
            renderApp(); // ì´ˆê¸° ë Œë”ë§
        }

        window.onload = initDB; 
    </script>
</head>

<body class="bg-beige-warm min-h-screen font-sans flex flex-col items-center p-4">
    
    <!-- Custom Alert Modal Structure -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300 opacity-0">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition duration-300">
            <h3 class="text-xl font-bold text-brown-dark mb-4">ì•Œë¦¼</h3>
            <p id="modal-message" class="text-brown-medium mb-6"></p>
            <button id="close-modal-button" class="w-full bg-brown-medium text-white py-2 rounded-lg hover:bg-brown-dark transition duration-200">
                í™•ì¸
            </button>
        </div>
    </div>

    <!-- Custom Password Input Modal Structure (New) -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300 opacity-0">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition duration-300">
            <h3 class="text-xl font-bold text-brown-dark mb-4">êµì‚¬ ì¸ì¦</h3>
            <p class="text-brown-medium mb-4">êµì‚¬ìš© í˜ì´ì§€ë¡œ ì „í™˜í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <input type="password" id="password-input" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-brown-medium focus:border-brown-medium" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            <button id="password-check-button" class="w-full bg-brown-medium text-white py-2 rounded-lg hover:bg-brown-dark transition duration-200 font-semibold">
                ì¸ì¦í•˜ê¸°
            </button>
        </div>
    </div>
    
    <!-- Header -->
    <header class="w-full max-w-3xl mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-brown-dark mb-2 leading-tight">
            ê³ ë ¤ ê³ ë“±í•™êµ 2-1ë°˜ì˜ ë¹„ë°€ìƒë‹´ì†Œ 
            <svg xmlns="http://www.w3.org/2000/svg" class="inline-block w-8 h-8 text-brown-medium ml-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 17H2V5h10v2h10z"/><path d="M7 9h6"/><path d="M7 13h4"/>
            </svg>
        </h1>
        <p id="user-id-display" class="text-xs text-gray-500 mt-2"></p>
        
        <div class="flex justify-center mt-4 space-x-4">
            <button id="view-toggle-button" class="bg-brown-medium text-white py-2 px-4 rounded-lg shadow-md hover:bg-brown-dark transition duration-300 font-semibold">
                êµì‚¬ìš© í˜ì´ì§€ë¡œ ì „í™˜
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="app-container" class="w-full max-w-3xl">
        <div id="app-content">
            <!-- Content will be rendered here by JavaScript -->
            <p class="text-center text-brown-medium p-8">í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </main>

    <!-- Footer for aesthetic spacing -->
    <footer class="mt-12 text-xs text-gray-400">
        &copy; 2025 2-1 Class Counseling
    </footer>
</body>
</html>